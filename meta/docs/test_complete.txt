#!/bin/bash

set -e
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() { echo -e "${GREEN}[OK]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
info() { echo -e "${BLUE}[INFO]${NC} $1"; }

echo ""
echo "======================================"
echo "  CYBERFORGE COMPLETE SYSTEM TEST"
echo "======================================"
echo ""

cd ~/Documents/cyberforge || error "Project not found"

# TEST 1: Backend Health
echo "=== TEST 1: Backend Health ==="
if curl -sf http://localhost:5000/api/health >/dev/null 2>&1; then
    log "Backend is running"
else
    error "Backend not responding"
fi

# TEST 2: Create Database and Test User
echo ""
echo "=== TEST 2: Database Creation ==="

if [ -f "backend/cyberforge.db" ]; then
    warn "Database already exists"
    log "Skipping creation"
else
    info "Creating database via API..."
    
    RESPONSE=$(curl -s -X POST http://localhost:5000/api/register \
        -H "Content-Type: application/json" \
        -d '{"username":"testadmin","email":"admin@cyberforge.local","password":"Admin123456"}')
    
    if echo "$RESPONSE" | grep -q "error"; then
        warn "Registration response: $RESPONSE"
    else
        log "Test user created: testadmin"
    fi
    
    sleep 2
    
    if [ -f "backend/cyberforge.db" ]; then
        log "Database created successfully"
        log "Location: backend/cyberforge.db"
        log "Size: $(du -h backend/cyberforge.db | cut -f1)"
    else
        error "Database creation failed"
    fi
fi

# TEST 3: Verify Database Structure
echo ""
echo "=== TEST 3: Database Structure ==="

if command -v sqlite3 >/dev/null 2>&1; then
    info "Tables in database:"
    sqlite3 backend/cyberforge.db ".tables"
    
    echo ""
    info "User count:"
    USER_COUNT=$(sqlite3 backend/cyberforge.db "SELECT COUNT(*) FROM user;" 2>/dev/null || echo "0")
    echo "  Users: $USER_COUNT"
    
    info "Challenge count:"
    CHALLENGE_COUNT=$(sqlite3 backend/cyberforge.db "SELECT COUNT(*) FROM challenge;" 2>/dev/null || echo "0")
    echo "  Challenges: $CHALLENGE_COUNT"
    
    if [ "$USER_COUNT" -gt 0 ]; then
        log "Database populated"
    else
        warn "No users in database"
    fi
else
    warn "sqlite3 not installed, skipping DB inspection"
fi

# TEST 4: API Authentication Flow
echo ""
echo "=== TEST 4: Authentication Flow ==="

info "Testing login..."
LOGIN_RESPONSE=$(curl -s -X POST http://localhost:5000/api/login \
    -H "Content-Type: application/json" \
    -d '{"username":"testadmin","password":"Admin123456"}')

if echo "$LOGIN_RESPONSE" | grep -q "access_token"; then
    TOKEN=$(echo "$LOGIN_RESPONSE" | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)
    log "Login successful"
    info "Token: ${TOKEN:0:20}..."
    
    info "Testing profile access..."
    PROFILE=$(curl -s http://localhost:5000/api/profile \
        -H "Authorization: Bearer $TOKEN")
    
    if echo "$PROFILE" | grep -q "testadmin"; then
        log "Profile access successful"
    else
        warn "Profile access failed"
    fi
else
    warn "Login failed or user already exists"
fi

# TEST 5: Challenges API
echo ""
echo "=== TEST 5: Challenges API ==="

CHALLENGES=$(curl -s http://localhost:5000/api/challenges)

if echo "$CHALLENGES" | grep -q "name"; then
    CHALLENGE_COUNT=$(echo "$CHALLENGES" | grep -o '"name"' | wc -l)
    log "Challenges API working"
    info "Found $CHALLENGE_COUNT challenges"
else
    warn "No challenges found"
fi

# TEST 6: Ports Check
echo ""
echo "=== TEST 6: Network Ports ==="

PORTS="3000 5000 2222 2223 2224 3001"
for PORT in $PORTS; do
    if nc -z localhost $PORT 2>/dev/null; then
        log "Port :$PORT open"
    else
        warn "Port :$PORT closed"
    fi
done

# TEST 7: Containers Status
echo ""
echo "=== TEST 7: Containers ==="

docker compose ps --format "table {{.Name}}\t{{.Status}}" | while read line; do
    if echo "$line" | grep -q "Up"; then
        log "$line"
    else
        info "$line"
    fi
done

# TEST 8: SSH Challenges
echo ""
echo "=== TEST 8: SSH Challenges ==="

for PORT in 2222 2223 2224; do
    if timeout 3 ssh -o StrictHostKeyChecking=no -o ConnectTimeout=2 \
        ctfuser@localhost -p $PORT "echo test" 2>&1 | grep -q "password"; then
        log "SSH Challenge :$PORT accepting connections"
    else
        info "SSH Challenge :$PORT status unclear"
    fi
done

# TEST 9: Security Check
echo ""
echo "=== TEST 9: Security Measures ==="

check_file() {
    if [ -f "$1" ] || [ -x "$1" ]; then
        log "$2"
    else
        warn "$2 missing"
    fi
}

check_file "backups/config.py.stable" "Backup exists"
check_file ".git/hooks/pre-commit" "Pre-commit hook installed"
check_file "backend/CONFIG_SECURITY.md" "Security docs present"
check_file "tests/verification/health_monitor.sh" "Health monitor ready"
check_file "tests/verification/auto_recover.sh" "Auto recovery ready"

if grep -q "sqlite:///cyberforge.db" backend/config.py; then
    log "Config uses SQLite"
else
    warn "Config check failed"
fi

# TEST 10: Final Report
echo ""
echo "======================================"
echo "  FINAL SYSTEM REPORT"
echo "======================================"
echo ""

TESTS_PASSED=0
TESTS_TOTAL=10

[ -f "backend/cyberforge.db" ] && TESTS_PASSED=$((TESTS_PASSED + 1))
curl -sf http://localhost:5000/api/health >/dev/null 2>&1 && TESTS_PASSED=$((TESTS_PASSED + 1))
nc -z localhost 3000 2>/dev/null && TESTS_PASSED=$((TESTS_PASSED + 1))
nc -z localhost 5000 2>/dev/null && TESTS_PASSED=$((TESTS_PASSED + 1))
nc -z localhost 2222 2>/dev/null && TESTS_PASSED=$((TESTS_PASSED + 1))
nc -z localhost 3001 2>/dev/null && TESTS_PASSED=$((TESTS_PASSED + 1))
[ -f "backups/config.py.stable" ] && TESTS_PASSED=$((TESTS_PASSED + 1))
[ -x ".git/hooks/pre-commit" ] && TESTS_PASSED=$((TESTS_PASSED + 1))
docker compose ps | grep -q "Up" && TESTS_PASSED=$((TESTS_PASSED + 1))
grep -q "sqlite:///cyberforge.db" backend/config.py && TESTS_PASSED=$((TESTS_PASSED + 1))

echo "Tests Passed: $TESTS_PASSED / $TESTS_TOTAL"
echo ""

if [ "$TESTS_PASSED" -ge 8 ]; then
    echo -e "${GREEN}Status: EXCELLENT${NC}"
    echo "System is production ready"
elif [ "$TESTS_PASSED" -ge 6 ]; then
    echo -e "${YELLOW}Status: GOOD${NC}"
    echo "System is mostly functional"
else
    echo -e "${RED}Status: NEEDS ATTENTION${NC}"
    echo "Some components require fixes"
fi

echo ""
echo "======================================"
echo "  TESTING COMPLETE"
echo "======================================"
echo ""

# Save detailed report
cat > test_report.txt << 'REPORT'
CYBERFORGE TEST REPORT
Generated: $(date)

DATABASE
--------
File: backend/cyberforge.db
Status: $([ -f backend/cyberforge.db ] && echo "EXISTS" || echo "MISSING")
Size: $([ -f backend/cyberforge.db ] && du -h backend/cyberforge.db | cut -f1 || echo "N/A")

API ENDPOINTS
-------------
Health: $(curl -sf http://localhost:5000/api/health >/dev/null 2>&1 && echo "OK" || echo "FAIL")
Challenges: $(curl -sf http://localhost:5000/api/challenges >/dev/null 2>&1 && echo "OK" || echo "FAIL")

PORTS
-----
Website (:3000): $(nc -z localhost 3000 2>/dev/null && echo "OPEN" || echo "CLOSED")
Backend (:5000): $(nc -z localhost 5000 2>/dev/null && echo "OPEN" || echo "CLOSED")
SSH-1 (:2222): $(nc -z localhost 2222 2>/dev/null && echo "OPEN" || echo "CLOSED")
SSH-2 (:2223): $(nc -z localhost 2223 2>/dev/null && echo "OPEN" || echo "CLOSED")
SSH-3 (:2224): $(nc -z localhost 2224 2>/dev/null && echo "OPEN" || echo "CLOSED")
Juice Shop (:3001): $(nc -z localhost 3001 2>/dev/null && echo "OPEN" || echo "CLOSED")

SECURITY
--------
Backup: $([ -f backups/config.py.stable ] && echo "OK" || echo "MISSING")
Pre-commit Hook: $([ -x .git/hooks/pre-commit ] && echo "OK" || echo "MISSING")
SQLite Config: $(grep -q sqlite:///cyberforge.db backend/config.py && echo "OK" || echo "FAIL")

SCORE: $TESTS_PASSED / $TESTS_TOTAL
REPORT

log "Detailed report saved: test_report.txt"

echo ""
info "Next steps:"
echo "  1. Open browser: xdg-open http://localhost:3000"
echo "  2. Check database: sqlite3 backend/cyberforge.db .tables"
echo "  3. View logs: docker compose logs backend"
echo ""

