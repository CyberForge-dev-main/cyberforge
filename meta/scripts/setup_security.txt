#!/bin/bash

set -e
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

PROJECT_DIR="$HOME/Documents/cyberforge"

log() { echo -e "${GREEN}[OK]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }

echo "=== CYBERFORGE SECURITY SETUP ==="
echo ""

cd "$PROJECT_DIR" || error "Проект не найден"

# PHASE 1: Git Backup
log "PHASE 1: Git commit и backup"
mkdir -p backups

if [ -d ".git" ]; then
    git add backend/config.py tests/verification/ 2>/dev/null || true
    git commit -m "fix(backend): SQLite hardcoded URI" 2>/dev/null || warn "Уже закоммичено"
    git tag -a v0.2.1-stable -m "Stable SQLite" 2>/dev/null || warn "Тег существует"
fi

cp backend/config.py backups/config.py.stable
cp docker-compose.yml backups/docker-compose.yml.stable
tar -czf backups/backup-$(date +%Y%m%d-%H%M%S).tar.gz \
    --exclude=node_modules --exclude=venv --exclude=.git \
    --exclude=__pycache__ --exclude='*.tar.gz' . 2>/dev/null

log "Backup создан"

# PHASE 2: Pre-commit Hook
if [ -d ".git" ]; then
    log "PHASE 2: Pre-commit hook"
    
    cat > .git/hooks/pre-commit << 'HOOK'
#!/bin/bash
echo "Проверка config.py..."
grep -q "postgresql://" backend/config.py && echo "ERROR: PostgreSQL!" && exit 1
grep -q "sqlite:///cyberforge.db" backend/config.py || exit 1
grep -q "os.environ.get" backend/config.py | grep -q "DATABASE_URL" && echo "ERROR: Dynamic!" && exit 1
echo "OK"
exit 0
HOOK
    
    chmod +x .git/hooks/pre-commit
    log "Hook создан"
fi

# PHASE 3: Documentation
log "PHASE 3: Документация"

cat > backend/CONFIG_SECURITY.md << 'DOC'
# Backend Config Security

## CRITICAL RULE

SQLALCHEMY_DATABASE_URI = sqlite:///cyberforge.db

## FORBIDDEN

- os.environ.get DATABASE_URL
- postgresql://

## Recovery

cp backups/config.py.stable backend/config.py
docker compose restart backend
DOC

log "Документация создана"

# PHASE 4: Health Monitor
log "PHASE 4: Мониторинг"
mkdir -p tests/verification

cat > tests/verification/health_monitor.sh << 'MONITOR'
#!/bin/bash
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

while true; do
    clear
    echo "=== HEALTH MONITOR ==="
    echo "$(date +%H:%M:%S)"
    echo ""
    
    grep -q "sqlite:///cyberforge.db" ~/Documents/cyberforge/backend/config.py \
        && echo -e "${GREEN}OK${NC} Config" \
        || echo -e "${RED}FAIL${NC} Config"
    
    curl -sf http://localhost:5000/api/health >/dev/null 2>&1 \
        && echo -e "${GREEN}OK${NC} Backend" \
        || echo -e "${RED}FAIL${NC} Backend"
    
    echo ""
    echo "Обновление 30с... Ctrl+C выход"
    sleep 30
done
MONITOR

chmod +x tests/verification/health_monitor.sh
log "Monitor создан"

# PHASE 5: Auto Recovery
cat > tests/verification/auto_recover.sh << 'RECOVER'
#!/bin/bash
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

cd ~/Documents/cyberforge

if ! curl -sf http://localhost:5000/api/health >/dev/null 2>&1; then
    echo -e "${RED}Backend не отвечает${NC}"
    
    if ! grep -q "sqlite:///cyberforge.db" backend/config.py; then
        echo -e "${YELLOW}Восстановление...${NC}"
        
        if [ -f "backups/config.py.stable" ]; then
            cp backups/config.py.stable backend/config.py
        else
            cat > backend/config.py << 'CFG'
import os
class Config:
    SECRET_KEY = os.environ.get('SECRET_KEY') or 'dev-key'
    SQLALCHEMY_DATABASE_URI = 'sqlite:///cyberforge.db'
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    JWT_SECRET_KEY = os.environ.get('JWT_SECRET_KEY') or 'jwt-key'
CFG
        fi
    fi
    
    docker compose restart backend
    sleep 10
    
    curl -sf http://localhost:5000/api/health >/dev/null 2>&1 \
        && echo -e "${GREEN}Восстановлен${NC}" \
        || echo -e "${RED}Не удалось${NC}"
else
    echo -e "${GREEN}Система OK${NC}"
fi
RECOVER

chmod +x tests/verification/auto_recover.sh
log "Recovery создан"

# PHASE 6: Init Database
cat > backend/init_database.py << 'INITDB'
import sys
from app import app, db
from models import Challenge

def init_database():
    with app.app_context():
        print("Создание таблиц...")
        db.create_all()
        print("OK Таблицы созданы")
        
        if Challenge.query.first():
            print("WARN БД уже содержит данные")
            return
        
        challenges = [
            {'name': 'Web Challenge 1', 'category': 'web', 'points': 100,
             'description': 'Find hidden flag', 'flag': 'flag{web_1}'},
            {'name': 'SSH Challenge 1', 'category': 'ssh', 'points': 150,
             'description': 'SSH flag', 'flag': 'flag{ssh_1}'},
            {'name': 'Juice Shop', 'category': 'web', 'points': 200,
             'description': 'Find vulnerabilities', 'flag': 'flag{juice}'}
        ]
        
        for ch in challenges:
            db.session.add(Challenge(**ch))
            print("  + " + ch['name'])
        
        db.session.commit()
        print("OK Челленджей: " + str(Challenge.query.count()))

if __name__ == '__main__':
    try:
        init_database()
    except Exception as e:
        print("ERROR: " + str(e))
        sys.exit(1)
INITDB

log "Init DB создан"

# PHASE 7: Security Check
cat > tests/verification/security_check.sh << 'CHECK'
#!/bin/bash
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

cd ~/Documents/cyberforge
echo "=== SECURITY CHECK ==="

check() {
    if [ $1 -eq 0 ]; then
        echo -e "${GREEN}OK${NC} $2"
    else
        echo -e "${RED}FAIL${NC} $2"
    fi
}

[ -f "backups/config.py.stable" ]; check $? "Backup"
[ -x ".git/hooks/pre-commit" ]; check $? "Hook"
[ -f "backend/CONFIG_SECURITY.md" ]; check $? "Docs"
[ -x "tests/verification/health_monitor.sh" ]; check $? "Monitor"
[ -x "tests/verification/auto_recover.sh" ]; check $? "Recovery"
[ -f "backend/init_database.py" ]; check $? "Init"
grep -q "sqlite:///cyberforge.db" backend/config.py; check $? "SQLite"
! grep -q "postgresql://" backend/config.py; check $? "NO Postgres"
curl -sf http://localhost:5000/api/health >/dev/null 2>&1; check $? "Backend"

echo ""
echo "=== ЗАВЕРШЕНО ==="
CHECK

chmod +x tests/verification/security_check.sh
log "Security Check создан"

echo ""
echo "==================================="
echo "ВСЕ УСТАНОВЛЕНО"
echo "==================================="
echo ""
echo "Следующие шаги:"
echo "1. docker compose exec backend python3 init_database.py"
echo "2. ./tests/verification/security_check.sh"

