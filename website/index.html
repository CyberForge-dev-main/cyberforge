<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberForge - CTF Platform</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #eee;
        }
        .hidden { display: none !important; }
        
        /* Header */
        header {
            background: rgba(0,0,0,0.3);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }
        header h1 { color: #00d4ff; font-size: 1.5em; }
        header .user-info { display: flex; align-items: center; gap: 15px; }
        header .user-info span { color: #aaa; }
        
        /* Buttons */
        .btn {
            background: #00d4ff;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .btn:hover { background: #00a8cc; }
        .btn-danger { background: #ff4757; color: #fff; }
        .btn-danger:hover { background: #ff3344; }
        .btn-secondary { background: #444; color: #fff; }
        .btn-secondary:hover { background: #555; }
        
        /* Auth Container */
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            background: rgba(255,255,255,0.05);
            padding: 40px;
            border-radius: 10px;
            border: 1px solid #333;
        }
        .auth-container h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #00d4ff;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #1a1a2e;
            color: #fff;
            font-size: 1em;
        }
        .form-group input:focus {
            outline: none;
            border-color: #00d4ff;
        }
        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: #aaa;
        }
        .auth-switch a {
            color: #00d4ff;
            cursor: pointer;
            text-decoration: none;
        }
        .error-msg {
            background: rgba(255,71,87,0.2);
            border: 1px solid #ff4757;
            color: #ff4757;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }
        .success-msg {
            background: rgba(0,212,255,0.2);
            border: 1px solid #00d4ff;
            color: #00d4ff;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
        }
        
        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #333;
        }
        .stat-card h3 { color: #00d4ff; font-size: 2em; margin-bottom: 5px; }
        .stat-card p { color: #aaa; }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: #aaa;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            transition: all 0.3s;
        }
        .tab:hover { color: #fff; }
        .tab.active {
            background: rgba(0,212,255,0.2);
            color: #00d4ff;
        }
        
        /* Challenges Grid */
        .challenges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        .challenge-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }
        .challenge-card:hover {
            border-color: #00d4ff;
            transform: translateY(-2px);
        }
        .challenge-card h3 { color: #fff; margin-bottom: 10px; }
        .challenge-card p { color: #aaa; margin-bottom: 15px; }
        .challenge-card .meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        .challenge-card .points { color: #00d4ff; font-weight: bold; }
        .challenge-card .port { color: #ffa502; }
        .challenge-card .solved { color: #2ed573; }
        
        /* Flag Input */
        .flag-form {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .flag-form input {
            flex: 1;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #1a1a2e;
            color: #fff;
        }
        
        /* Leaderboard */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            overflow: hidden;
        }
        .leaderboard-table th,
        .leaderboard-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        .leaderboard-table th {
            background: rgba(0,212,255,0.1);
            color: #00d4ff;
        }
        .leaderboard-table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 50px;
            color: #aaa;
        }
    </style>
</head>
<body>
    <!-- AUTH PAGE -->
    <div id="auth-page">
        <div class="auth-container">
            <h2 id="auth-title">Login to CyberForge</h2>
            <div id="auth-error" class="error-msg hidden"></div>
            <div id="auth-success" class="success-msg hidden"></div>
            
            <form id="auth-form">
                <div class="form-group" id="email-group" style="display:none;">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="user@example.com">
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="username" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn" style="width:100%;" id="auth-btn">Login</button>
            </form>
            
            <div class="auth-switch">
                <span id="switch-text">Don't have an account?</span>
                <a id="switch-link" onclick="toggleAuthMode()">Register</a>
            </div>
        </div>
    </div>

    <!-- DASHBOARD PAGE -->
    <div id="dashboard-page" class="hidden">
        <header>
            <h1>CyberForge</h1>
            <div class="user-info">
                <span>Welcome, <strong id="user-display"></strong></span>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </header>
        
        <div class="main-content">
            <div class="stats-bar">
                <div class="stat-card">
                    <h3 id="stat-solved">0</h3>
                    <p>Challenges Solved</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-points">0</h3>
                    <p>Total Points</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-rank">-</h3>
                    <p>Your Rank</p>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('challenges')">Challenges</button>
                <button class="tab" onclick="showTab('leaderboard')">Leaderboard</button>
            </div>
            
            <div id="challenges-tab">
                <div id="challenges-grid" class="challenges-grid">
                    <div class="loading">Loading challenges...</div>
                </div>
            </div>
            
            <div id="leaderboard-tab" class="hidden">
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Username</th>
                            <th>Solved</th>
                            <th>Points</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <tr><td colspan="4" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';
        let isLoginMode = true;
        let currentUser = null;
        let authToken = null;
        let solvedChallenges = new Set();

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('access_token');
            const user = localStorage.getItem('user');
            if (token && user) {
                authToken = token;
                currentUser = JSON.parse(user);
                showDashboard();
            }
            document.getElementById('auth-form').addEventListener('submit', handleAuth);
        });

        // Toggle Login/Register
        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-title').textContent = isLoginMode ? 'Login to CyberForge' : 'Create Account';
            document.getElementById('auth-btn').textContent = isLoginMode ? 'Login' : 'Register';
            document.getElementById('switch-text').textContent = isLoginMode ? "Don't have an account?" : 'Already have an account?';
            document.getElementById('switch-link').textContent = isLoginMode ? 'Register' : 'Login';
            document.getElementById('email-group').style.display = isLoginMode ? 'none' : 'block';
            hideMessages();
        }

        // Handle Auth
        async function handleAuth(e) {
            e.preventDefault();
            hideMessages();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const email = document.getElementById('email').value || username + '@example.local';

            try {
                if (isLoginMode) {
                    const res = await fetch(API_URL + '/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Login failed');
                    
                    authToken = data.access_token;
                    currentUser = data.user;
                    localStorage.setItem('access_token', authToken);
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    showDashboard();
                } else {
                    const res = await fetch(API_URL + '/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, email, password })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Registration failed');
                    
                    showSuccess('Account created! Please login.');
                    toggleAuthMode();
                }
            } catch (err) {
                showError(err.message);
            }
        }

        // Show Dashboard
        function showDashboard() {
            document.getElementById('auth-page').classList.add('hidden');
            document.getElementById('dashboard-page').classList.remove('hidden');
            document.getElementById('user-display').textContent = currentUser.username;
            loadChallenges();
            loadProgress();
            loadLeaderboard();
        }

        // Logout
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user');
            authToken = null;
            currentUser = null;
            document.getElementById('auth-page').classList.remove('hidden');
            document.getElementById('dashboard-page').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Load Challenges
        async function loadChallenges() {
            try {
                const res = await fetch(API_URL + '/challenges');
                const challenges = await res.json();
                
                const grid = document.getElementById('challenges-grid');
                grid.innerHTML = challenges.map(c => `
                    <div class="challenge-card" id="challenge-${c.id}">
                        <h3>${escapeHtml(c.name)}</h3>
                        <p>${escapeHtml(c.description)}</p>
                        <div class="meta">
                            <span class="points">${c.points} pts</span>
                            <span class="port">SSH Port: ${c.port}</span>
                            <span class="solved" id="solved-${c.id}"></span>
                        </div>
                        <div class="flag-form">
                            <input type="text" id="flag-input-${c.id}" placeholder="flag{...}">
                            <button class="btn" onclick="submitFlag(${c.id})">Submit</button>
                        </div>
                        <div id="flag-result-${c.id}" style="margin-top:10px;"></div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error loading challenges:', err);
            }
        }

        // Load Progress
        async function loadProgress() {
            try {
                const res = await fetch(API_URL + '/user/progress', {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('stat-solved').textContent = data.challenges_solved;
                    document.getElementById('stat-points').textContent = data.total_points;
                }
            } catch (err) {
                console.error('Error loading progress:', err);
            }
        }

        // Load Leaderboard
        async function loadLeaderboard() {
            try {
                const res = await fetch(API_URL + '/leaderboard', {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                if (res.ok) {
                    const data = await res.json();
                    const tbody = document.getElementById('leaderboard-body');
                    tbody.innerHTML = data.map((u, i) => {
                        const rankClass = i < 3 ? 'rank-' + (i+1) : '';
                        const isMe = u.username === currentUser.username;
                        if (isMe) document.getElementById('stat-rank').textContent = '#' + (i+1);
                        return `
                            <tr style="${isMe ? 'background:rgba(0,212,255,0.1);' : ''}">
                                <td class="${rankClass}">#${i+1}</td>
                                <td>${escapeHtml(u.username)}${isMe ? ' (you)' : ''}</td>
                                <td>${u.solved}</td>
                                <td>${u.points}</td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (err) {
                console.error('Error loading leaderboard:', err);
            }
        }

        // Submit Flag
        async function submitFlag(challengeId) {
            const input = document.getElementById('flag-input-' + challengeId);
            const result = document.getElementById('flag-result-' + challengeId);
            const flag = input.value.trim();
            
            if (!flag) {
                result.innerHTML = '<span style="color:#ff4757;">Enter a flag</span>';
                return;
            }

            try {
                const res = await fetch(API_URL + '/submit_flag', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken
                    },
                    body: JSON.stringify({ challenge_id: challengeId, flag: flag })
                });
                const data = await res.json();
                
                if (res.status === 429) {
                    result.innerHTML = '<span style="color:#ffa502;">Rate limited! Wait 60 seconds.</span>';
                    return;
                }
                
                if (data.success) {
                    result.innerHTML = '<span style="color:#2ed573;">Correct! +' + data.points + ' points</span>';
                    document.getElementById('solved-' + challengeId).textContent = 'âœ“ Solved';
                    input.value = '';
                    loadProgress();
                    loadLeaderboard();
                } else {
                    result.innerHTML = '<span style="color:#ff4757;">' + escapeHtml(data.message) + '</span>';
                }
            } catch (err) {
                result.innerHTML = '<span style="color:#ff4757;">Error: ' + escapeHtml(err.message) + '</span>';
            }
        }

        // Tab Switching
        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[onclick="showTab('${tab}')"]`).classList.add('active');
            
            document.getElementById('challenges-tab').classList.toggle('hidden', tab !== 'challenges');
            document.getElementById('leaderboard-tab').classList.toggle('hidden', tab !== 'leaderboard');
            
            if (tab === 'leaderboard') loadLeaderboard();
        }

        // Helpers
        function showError(msg) {
            const el = document.getElementById('auth-error');
            el.textContent = msg;
            el.classList.remove('hidden');
        }
        function showSuccess(msg) {
            const el = document.getElementById('auth-success');
            el.textContent = msg;
            el.classList.remove('hidden');
        }
        function hideMessages() {
            document.getElementById('auth-error').classList.add('hidden');
            document.getElementById('auth-success').classList.add('hidden');
        }
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
